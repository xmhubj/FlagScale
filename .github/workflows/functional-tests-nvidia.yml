name: Functional Tests Nvidia

on:
  workflow_call:
    inputs:
      type:
        required: true
        type: string
      task:
        required: true
        type: string
      image:
        required: true
        type: string

jobs:
  functional-test:
    runs-on: [self-hosted, Linux, X64, nvidia-0, gpus-8]
    defaults:
      run:
        shell: bash
    container:
      image: ${{ inputs.image }}
      ports:
        - 80
      volumes:
        - /home/flagscale_cicd/flask/static:/workspace/report
        - /home/flagscale_cicd/docker/docker_build/docker_data:/home/gitlab-runner/data
        - /home/flagscale_cicd/docker/docker_build/docker_tokenizers:/home/gitlab-runner/tokenizers
        - /home/flagscale_cicd/sccache:/root/.cache/sccache
      options: --gpus all --shm-size=500g --hostname flagscale_cicd --user root --ulimit nofile=65535:65535

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
          ssh-strict: true
          ssh-user: git
          persist-credentials: true
          clean: true
          sparse-checkout-cone-mode: true
          fetch-tags: false
          show-progress: true
          lfs: false
          submodules: false
          set-safe-directory: true
          retry-on-intr: fail=5,delay=180000

      - name: Install FlagScale training dependencies
        timeout-minutes: 30
        if: ${{ inputs.type == 'train' || inputs.type == 'hetero_train' }}
        run: |
          echo "Current type: ${{ inputs.type }}"
          echo "ðŸ“Œ GitHub Actions default workspace: $GITHUB_WORKSPACE"

          source /root/miniconda3/bin/activate flagscale-train
          source .github/workflows/scripts/retry_functions.sh

          COMMANDS=(
            "rm -rf ${GITHUB_WORKSPACE}/Megatron-LM-FL"
            "git clone https://github.com/flagos-ai/Megatron-LM-FL.git"
            "pip install httpx multi-storage-client boto3 google-cloud-storage fastapi uvicorn griffe"
            "cd ${GITHUB_WORKSPACE}/Megatron-LM-FL"
            "pip install --no-build-isolation . -vvv"
          )

          retry_commands 3 "${COMMANDS[@]}"

      - name:  Install FlagScale inference dependencies
        timeout-minutes: 90
        if: ${{ inputs.type == 'inference' || inputs.type == 'serve' }}
        env:
          SCCACHE_DIR: /root/.cache/sccache
        run: |
          echo "Current type: ${{ inputs.type }}"
          echo "ðŸ“Œ GitHub Actions default workspace: $GITHUB_WORKSPACE"

          source /root/miniconda3/bin/activate flagscale-inference
          source .github/workflows/scripts/retry_functions.sh

          # install FlagGems
          INSTALL_FLAGGEMS=(
            "pip install scikit-build scikit-build-core"
            "pip install git+https://github.com/FlagOpen/FlagGems.git@v3.0"
          )
          retry_commands 3 "${INSTALL_FLAGGEMS[@]}"

          # modify for support 0.5b_multiple_instance ci test because of ray version issue
          Additional_dependencies=(
            "pip install ray==2.49.1"
            "pip install gymnasium"
            "pip install dm-tree"
          )
          retry_commands 3 "${Additional_dependencies[@]}"

          # install vllm
          INSTALL_VLLM=(
            "rm -rf ${GITHUB_WORKSPACE}/vllm-FL"
            "git clone https://github.com/flagos-ai/vllm-FL.git"
            "cd ${GITHUB_WORKSPACE}/vllm-FL"
            "sccache --start-server"
            "sccache --show-stats"
            "pip install --no-build-isolation . -vvv"
            "sccache --show-stats"
          )
          retry_commands 3 "${INSTALL_VLLM[@]}"

      - name: Run Functional Test
        id: functional_test
        timeout-minutes: 30
        run: |
          git config --global --add safe.directory ${GITHUB_WORKSPACE}
          tests/scripts/functional_tests/test_task.sh --type ${{ inputs.type }} --task ${{ inputs.task }}
          exit_code=$?
          echo "Exit code: $exit_code"
          exit $exit_code

      - name: Upload Functional Test Logs
        if: always() && steps.functional_test.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: functional_tests-logs-${{ github.run_id }}
          path: tests/functional_tests/test_cases/${{ inputs.type }}/${{ inputs.task }}/results_test
          retention-days: 7
          if-no-files-found: warn
